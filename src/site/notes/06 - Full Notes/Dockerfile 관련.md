---
{"dg-publish":true,"permalink":"/06-full-notes/dockerfile/","dgPassFrontmatter":true}
---

[[03 - Tags/Docker\|Docker]]
# 핵심 필기

## Dockerfile 커맨드
| 명령어           | 분류    | 사용 시점       | 실행 시점              | 설명 및 추가 정보                                                    |
| ------------- | ----- | ----------- | ------------------ | ------------------------------------------------------------- |
| `FROM`        | 빌드 타임 | 이미지 빌드 시작 시 | 이미지 빌드 시           | 베이스 이미지를 지정합니다. 모든 Dockerfile은 반드시 `FROM`으로 시작해야 합니다.         |
| `RUN`         | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 쉘 명령어를 실행하여 이미지를 빌드합니다. 예: 패키지 설치, 파일 수정 등.                   |
| `CMD`         | 런타임   | 컨테이너 실행 시   | 컨테이너 시작 시          | 컨테이너가 실행될 때 기본으로 실행할 명령어를 지정합니다. `CMD`는 오버라이드 가능합니다.          |
| `ENTRYPOINT`  | 런타임   | 컨테이너 실행 시   | 컨테이너 시작 시          | 컨테이너가 실행될 때 항상 실행할 명령어를 지정합니다. `CMD`와 함께 사용하여 인자를 전달할 수 있습니다. |
| `COPY`        | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 파일과 디렉토리를 호스트에서 이미지로 복사합니다. `COPY`는 기본적인 파일 복사에 사용됩니다.        |
| `ADD`         | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | `COPY`와 유사하지만, 압축 파일 자동 해제, URL에서 파일 다운로드 등 추가 기능을 제공합니다.     |
| `ENV`         | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 환경 변수를 설정합니다. 설정된 환경 변수는 빌드 및 런타임에서 모두 사용 가능합니다.              |
| `EXPOSE`      | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 컨테이너가 리스닝할 포트를 문서화합니다. 실제 포트 개방은 아닙니다.                        |
| `VOLUME`      | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 데이터 볼륨을 마운트할 지점을 지정합니다. 데이터 지속성을 위해 사용됩니다.                    |
| `WORKDIR`     | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 작업 디렉토리를 설정합니다. 이후 명령어들은 설정된 디렉토리에서 실행됩니다.                    |
| `USER`        | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 명령어를 실행할 사용자와 그룹을 설정합니다. 보안 강화를 위해 권한이 낮은 사용자를 지정할 때 유용합니다.   |
| `ARG`         | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 빌드 시 전달할 수 있는 변수를 정의합니다. `ENV`와 달리 런타임에서 접근할 수 없습니다.          |
| `LABEL`       | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 메타데이터를 추가합니다. 예: 버전, 작성자 등.                                   |
| `HEALTHCHECK` | 런타임   | 컨테이너 실행 시   | 컨테이너 실행 중 주기적으로 실행 | 컨테이너의 상태를 점검하는 명령어를 정의합니다.                                    |
| `ONBUILD`     | 빌드 타임 | 이미지 빌드 시    | 부모 이미지가 빌드될 때 실행됨  | 후속 빌드 단계에서 실행될 명령어를 미리 정의합니다. 주로 베이스 이미지를 만들 때 사용됩니다.         |
| `SHELL`       | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 기본 쉘을 변경합니다. 예: `SHELL ["powershell", "-command"]`            ||

## 빌드 타임 vs 런타임 명령어 요약

|   |   |   |
|---|---|---|
|분류|명령어|설명|
|**빌드 타임**|`FROM`, `RUN`, `COPY`, `ADD`, `ENV`, `EXPOSE`, `VOLUME`, `WORKDIR`, `USER`, `ARG`, `LABEL`, `ONBUILD`, `SHELL`|이미지 빌드 과정에서 실행되며, 이미지의 레이어를 구성합니다.|
|**런타임**|`CMD`, `ENTRYPOINT`, `HEALTHCHECK`|컨테이너 실행 시 동작하며, 애플리케이션의 실행 방식을 정의합니다.|

	
## Dockerfile 구문 설명
Dockerfile의 명령어들은 **이미지 빌드 시**와 **컨테이너 실행 시**에 따라 사용 시점과 실행 시점이 다릅니다. 각 명령어의 역할과 실행 시점을 이해하면 Docker 이미지를 효율적으로 작성하고 관리할 수 있습니다. 아래에서는 주요 Dockerfile 명령어들을 사용 시점, 실행 시점, 그리고 기타 관련 정보와 함께 자세히 설명드리겠습니다.

---
## Dockerfile 명령어 개요
Dockerfile은 일련의 명령어들로 구성되며, 이 명령어들은 Docker 이미지를 생성하는 데 필요한 단계들을 정의합니다. 각 명령어는 특정 시점에 실행되며, 그 목적에 따라 분류할 수 있습니다.

### 1. **빌드 타임(Build Time) 명령어**
이미지 빌드 과정에서 실행되며, 이미지의 레이어를 생성합니다.

### 2. **런타임(Runtime) 명령어**
컨테이너가 실행될 때 동작하며, 애플리케이션의 동작 방식을 정의합니다.

---

## 주요 Dockerfile 명령어 상세 설명

아래 표는 주요 Dockerfile 명령어들을 빌드 타임과 런타임으로 분류하고, 각 명령어의 역할과 사용 시점, 실행 시점 등을 정리한 것입니다.

| 명령어           | 분류    | 사용 시점       | 실행 시점              | 설명 및 추가 정보                                                    |
| ------------- | ----- | ----------- | ------------------ | ------------------------------------------------------------- |
| `FROM`        | 빌드 타임 | 이미지 빌드 시작 시 | 이미지 빌드 시           | 베이스 이미지를 지정합니다. 모든 Dockerfile은 반드시 `FROM`으로 시작해야 합니다.         |
| `RUN`         | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 쉘 명령어를 실행하여 이미지를 빌드합니다. 예: 패키지 설치, 파일 수정 등.                   |
| `CMD`         | 런타임   | 컨테이너 실행 시   | 컨테이너 시작 시          | 컨테이너가 실행될 때 기본으로 실행할 명령어를 지정합니다. `CMD`는 오버라이드 가능합니다.          |
| `ENTRYPOINT`  | 런타임   | 컨테이너 실행 시   | 컨테이너 시작 시          | 컨테이너가 실행될 때 항상 실행할 명령어를 지정합니다. `CMD`와 함께 사용하여 인자를 전달할 수 있습니다. |
| `COPY`        | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 파일과 디렉토리를 호스트에서 이미지로 복사합니다. `COPY`는 기본적인 파일 복사에 사용됩니다.        |
| `ADD`         | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | `COPY`와 유사하지만, 압축 파일 자동 해제, URL에서 파일 다운로드 등 추가 기능을 제공합니다.     |
| `ENV`         | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 환경 변수를 설정합니다. 설정된 환경 변수는 빌드 및 런타임에서 모두 사용 가능합니다.              |
| `EXPOSE`      | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 컨테이너가 리스닝할 포트를 문서화합니다. 실제 포트 개방은 아닙니다.                        |
| `VOLUME`      | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 데이터 볼륨을 마운트할 지점을 지정합니다. 데이터 지속성을 위해 사용됩니다.                    |
| `WORKDIR`     | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 작업 디렉토리를 설정합니다. 이후 명령어들은 설정된 디렉토리에서 실행됩니다.                    |
| `USER`        | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 명령어를 실행할 사용자와 그룹을 설정합니다. 보안 강화를 위해 권한이 낮은 사용자를 지정할 때 유용합니다.   |
| `ARG`         | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 빌드 시 전달할 수 있는 변수를 정의합니다. `ENV`와 달리 런타임에서 접근할 수 없습니다.          |
| `LABEL`       | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 메타데이터를 추가합니다. 예: 버전, 작성자 등.                                   |
| `HEALTHCHECK` | 런타임   | 컨테이너 실행 시   | 컨테이너 실행 중 주기적으로 실행 | 컨테이너의 상태를 점검하는 명령어를 정의합니다.                                    |
| `ONBUILD`     | 빌드 타임 | 이미지 빌드 시    | 부모 이미지가 빌드될 때 실행됨  | 후속 빌드 단계에서 실행될 명령어를 미리 정의합니다. 주로 베이스 이미지를 만들 때 사용됩니다.         |
| `SHELL`       | 빌드 타임 | 이미지 빌드 시    | 이미지 빌드 시           | 기본 쉘을 변경합니다. 예: `SHELL ["powershell", "-command"]`            |

---

## 명령어별 상세 설명

### 1. `FROM`

- **분류**: 빌드 타임
- **사용 시점**: Docker 이미지 빌드의 시작
- **실행 시점**: 이미지 빌드 시
- **설명**:
		- 베이스 이미지를 지정합니다.
		- 모든 Dockerfile은 반드시 하나 이상의 `FROM` 명령어로 시작해야 합니다.
		- 멀티-스테이지 빌드에서 여러 `FROM`을 사용할 수 있습니다.

**예시**:

``` dockerfile
FROM ubuntu:20.04
```

### 2. `RUN`

- **분류**: 빌드 타임
- **사용 시점**: 이미지 빌드 과정 중
- **실행 시점**: 이미지 빌드 시
- **설명**:
	- 쉘 명령어를 실행하여 이미지를 빌드합니다.
	- 예: 패키지 설치, 파일 생성 등.

**예시**:

``` dockerfile
RUN apt-get update && apt-get install -y nginx

```

### 3. `COPY`

- **분류**: 빌드 타임
- **사용 시점**: 이미지 빌드 과정 중
- **실행 시점**: 이미지 빌드 시
- **설명**:
	- 호스트 파일 시스템에서 파일이나 디렉토리를 이미지로 복사합니다.
	- 상대 경로와 절대 경로 모두 사용 가능합니다.

**예시**:

``` dockerfile
COPY ./app /usr/src/app
```

### 4. `ADD`

- **분류**: 빌드 타임
- **사용 시점**: 이미지 빌드 과정 중
- **실행 시점**: 이미지 빌드 시
- **설명**:
	- `COPY`와 유사하지만, 추가 기능이 있습니다.
	- URL에서 파일을 다운로드하거나, 압축 파일을 자동으로 해제할 수 있습니다.
	- 권장: 단순 복사는 `COPY` 사용.

**예시**:

``` dockerfile
ADD https://example.com/file.tar.gz /tmp/
```

> [!important]  
> COPY vs ADD: ADD가 더 다양한 기능을 제공하지만 외부 소스에 의존한다는 문제점이 있으므로 되도록 COPY를 사용하는 것을 권장합니다. (ADD는 외부 소스에 의존하므로 보안적 측면이나 멱등성에도 문제가 생길 수 있다.)  

### 5. `CMD`

- **분류**: 런타임
- **사용 시점**: 컨테이너 실행 시
- **실행 시점**: 컨테이너 시작 시
- **설명**:
	- 컨테이너가 시작될 때 기본으로 실행할 명령어를 지정합니다.
	- `CMD`는 오버라이드할 수 있습니다 (`docker run` 시 명령어 지정).

**예시**:

``` dockerfile
CMD ["python", "app.py"]
```

### 6. `ENTRYPOINT`

- **분류**: 런타임
- **사용 시점**: 컨테이너 실행 시
- **실행 시점**: 컨테이너 시작 시
- **설명**:
		- 컨테이너가 시작될 때 항상 실행할 명령어를 지정합니다.
		- `ENTRYPOINT`와 `CMD`를 함께 사용하여 인자를 전달할 수 있습니다.
		- `ENTRYPOINT`는 오버라이드하기 어려워, 기본 실행 환경을 설정할 때 유용합니다.

**예시**:

``` dockerfile
ENTRYPOINT ["nginx", "-g", "daemon off;"]
```

### 7. `ENV`

- **분류**: 빌드 타임
- **사용 시점**: 이미지 빌드 과정 중
- **실행 시점**: 이미지 빌드 시 및 컨테이너 실행 시
- **설명**:
		- 환경 변수를 설정합니다.
		- 설정된 변수는 빌드 과정과 런타임 모두에서 사용 가능합니다.

**예시**:

``` dockerfile
ENV APP_ENV=production
```

### 8. `EXPOSE`

- **분류**: 빌드 타임
- **사용 시점**: 이미지 빌드 과정 중
- **실행 시점**: 이미지 빌드 시
- **설명**:
		- 컨테이너가 리스닝할 포트를 문서화합니다.
		- 실제 포트 개방을 의미하지 않으며, `docker run` 시 `p` 옵션과 함께 사용됩니다.

**예시**:

``` dockerfile
EXPOSE 8080
```

### 9. `VOLUME`

- **분류**: 빌드 타임
- **사용 시점**: 이미지 빌드 과정 중
- **실행 시점**: 이미지 빌드 시 및 컨테이너 실행 시
- **설명**:
	- 데이터 볼륨을 마운트할 지점을 지정합니다.
	- 데이터 지속성을 위해 사용되며, 호스트나 다른 컨테이너와 데이터 공유 시 유용합니다.
	- 익명 볼륨을 생성하며 컨테이너가 삭제되면 볼륨도 삭제된다. docker container run -v /container-location IMAGE_NAME

**예시**:

``` dockerfile
VOLUME /data
```

> [!important]  
> 바인드 마운트, 익명 볼륨, named 볼륨의 차이점: 볼륨은 Docker Daemon에서 제어하는 기억공간을 사용한다. 여기서 익명 볼륨과 named 볼륨으로 나뉘는데 익명 볼륨은 컨테이너가 삭제되면 같이 삭제되는 반면 named 볼륨은 컨테이너를 삭제해도 삭제되지 않는다.바인드 마운트는 볼륨과는 별개 개념으로 호스트의 기억 공간을 공유한다는 점은 볼륨과 같지만 Docker Daemon 공간이 아니라 호스트 전체 영역을 마운트가 가능하다.  

	

### 10. `WORKDIR`

- **분류**: 빌드 타임
- **사용 시점**: 이미지 빌드 과정 중
- **실행 시점**: 이미지 빌드 시 및 컨테이너 실행 시
- **설명**:
		- 작업 디렉토리를 설정합니다.
		- 이후의 `RUN`, `CMD`, `ENTRYPOINT`, `COPY`, `ADD` 명령어는 설정된 디렉토리에서 실행됩니다.

**예시**:

``` dockerfile
WORKDIR /usr/src/app
```

### 11. `USER`

- **분류**: 빌드 타임
- **사용 시점**: 이미지 빌드 과정 중
- **실행 시점**: 이미지 빌드 시 및 컨테이너 실행 시
- **설명**:
		- 명령어를 실행할 사용자와 그룹을 설정합니다.
		- 보안 강화를 위해 권한이 낮은 사용자를 지정할 때 유용합니다.

**예시**:

``` dockerfile
USER www-data
```

### 12. `ARG`

- **분류**: 빌드 타임
- **사용 시점**: 이미지 빌드 과정 중
- **실행 시점**: 이미지 빌드 시
- **설명**:
		- 빌드 시 전달할 수 있는 변수를 정의합니다.
		- `ENV`와 달리 런타임에서 접근할 수 없습니다.
		- 빌드 시 `-build-arg` 옵션으로 값을 전달할 수 있습니다.

**예시**:

``` dockerfile
ARG VERSION=1.0
RUN echo "Version is $VERSION"
```

### 13. `LABEL`

- **분류**: 빌드 타임
- **사용 시점**: 이미지 빌드 과정 중
- **실행 시점**: 이미지 빌드 시
- **설명**:
		- 메타데이터를 추가합니다. 예: 버전, 작성자, 라이선스 등.
		- 키-값 쌍으로 정보를 저장할 수 있습니다.

**예시**:

``` dockerfile
LABEL maintainer="youremail@example.com"
LABEL version="1.0"

```

### 14. `HEALTHCHECK`

- **분류**: 런타임
- **사용 시점**: 컨테이너 실행 시
- **실행 시점**: 컨테이너 실행 중 주기적으로 실행
- **설명**:
		- 컨테이너의 상태를 점검하는 명령어를 정의합니다.
		- `docker ps`에서 상태를 확인할 수 있습니다.

**예시**:

``` dockerfile
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
	CMD curl -f http://localhost/ || exit 1
```

### 15. `ONBUILD`

- **분류**: 빌드 타임
- **사용 시점**: 이미지 빌드 과정 중
- **실행 시점**: 부모 이미지가 빌드될 때 후속 빌드 단계에서 실행
- **설명**:
		- 후속 빌드 단계에서 실행될 명령어를 미리 정의합니다.
		- 주로 베이스 이미지를 만들 때 사용됩니다.

**예시**:

``` dockerfile

ONBUILD COPY . /app/src
ONBUILD RUN make /app/src

```

### 16. `SHELL`

- **분류**: 빌드 타임
- **사용 시점**: 이미지 빌드 과정 중
- **실행 시점**: 이미지 빌드 시
- **설명**:
		- 기본 쉘을 변경합니다.
		- 예: 기본 쉘을 PowerShell로 변경.

**예시**:

``` Dockerfile
SHELL ["powershell", "-command"]

```

---

## 빌드 타임 vs 런타임 명령어 요약

|   |   |   |
|---|---|---|
|분류|명령어|설명|
|**빌드 타임**|`FROM`, `RUN`, `COPY`, `ADD`, `ENV`, `EXPOSE`, `VOLUME`, `WORKDIR`, `USER`, `ARG`, `LABEL`, `ONBUILD`, `SHELL`|이미지 빌드 과정에서 실행되며, 이미지의 레이어를 구성합니다.|
|**런타임**|`CMD`, `ENTRYPOINT`, `HEALTHCHECK`|컨테이너 실행 시 동작하며, 애플리케이션의 실행 방식을 정의합니다.|

---

## 추가 정보 및 권장 사항

### 1. **명령어의 순서**
- Dockerfile의 명령어들은 **명시된 순서대로 실행**됩니다.
- 명령어 순서는 이미지의 레이어를 형성하며, 캐시 효율성에 영향을 미칩니다.
- 빈번히 변경되는 파일이나 명령어는 Dockerfile의 하단에 배치하여 빌드 캐시를 최대한 활용할 수 있습니다.

### 2. **캐시 활용**
- Docker는 이전 빌드의 레이어를 캐싱하여 동일한 명령어가 반복될 때 빌드를 빠르게 수행합니다.
- 캐시 효율성을 높이기 위해 빈번히 변경되지 않는 명령어와 파일은 상단에 배치합니다.

**예시**:

``` Dockerfile
# 종속성 설치 (변경되지 않음)
COPY requirements.txt .
RUN pip install -r requirements.txt

# 소스 코드 복사 (자주 변경됨)
COPY . .

```

### 3. **멀티 스테이지 빌드**
- 멀티 스테이지를 사용하면 최종적으로 빌드된 이미지를 사용합니다.
- 따라서, 빌드 도구와 소스 코드를 최종 이미지에 포함시키지 않고 필요한 실행 파일이나 바이너리만 포함할 수 있습니다.
**예시**:

``` Dockerfile
# 빌드 스테이지
FROM golang:1.16 AS builder
WORKDIR /app
COPY . .
RUN go build -o myapp

# 실행 스테이지
FROM alpine:latest
WORKDIR /app
COPY --from=builder /app/myapp .
CMD ["./myapp"]

```

### 4. `CMD` **vs** `ENTRYPOINT`
- `CMD`는 기본 명령어를 지정하며, `docker run` 시 오버라이드할 수 있습니다.
- `ENTRYPOINT`는 고정된 명령어를 지정하며, `docker run` 시 인자만 추가할 수 있습니다.
- 함께 사용하여 유연성을 높일 수 있습니다.

**예시**:

```dockerfile
ENTRYPOINT ["python", "app.py"]
CMD ["--help"]
```
- 실행 시: `docker run myimage` → `python app.py --help`
- 실행 시: `docker run myimage --version` → `python app.py --version`

### 5. **환경 변수와 빌드 아규먼트**
- `ENV`는 런타임에서도 접근 가능한 환경 변수를 설정합니다.
- `ARG`는 빌드 타임에만 접근 가능한 변수를 설정합니다.

**예시**:
```Plain
dockerfile
코드 복사
ARG BUILD_VERSION=1.0
ENV APP_VERSION=$BUILD_VERSION

```

### 6. **보안 고려사항**
- **비밀번호, API 키 등 민감 정보**는 Dockerfile에 직접 작성하지 않습니다.
- 대신, **빌드 아규먼트**나 **런타임 환경 변수**를 활용합니다.
- **비밀 관리 도구**(예: Docker Secrets, AWS Secrets Manager)와 연동하여 보안을 강화합니다.
### 7. **이미지 최적화**
- **경량 베이스 이미지 사용**: `alpine` 등 경량 이미지를 사용하여 이미지 크기를 줄입니다.
- **불필요한 파일 제거**: 빌드 과정에서 생성된 임시 파일이나 캐시를 제거하여 이미지 크기를 최소화합니다.
**예시**:
``` dockerfile
RUN \
	apt-get update && apt-get install -y build-essential \
	 && rm -rf /var/lib/apt/lists/*
```
### 8. **컨테이너 실행 시 추가 옵션**

- `docker run` 명령어를 사용할 때 포트 매핑(`p`), 볼륨 마운트(`v`), 환경 변수 설정(`e`) 등 다양한 옵션을 활용할 수 있습니다.

**예시**:

``` bash
docker run -d -p 8080:80 -v /host/data:/container/data -e ENV=production myimage

```
