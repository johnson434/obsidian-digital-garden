---
{"dg-publish":true,"permalink":"/06-full-notes/it-3-tcp-udp/","noteIcon":""}
---

[[03 - Tags/IT Engineer를 위한 네트워크\|IT Engineer를 위한 네트워크]]
# 단서 질문
- 유니캐스트, 멀티캐스트, 브로드캐스트, **애니캐스트란**?
    유니캐스트: 1대1통신
    멀티캐스트: 1대 다수
    브로드캐스트:1대 해당 네트워크에 속한 모든 노드들
    애니캐스트: 1대1이지만 해당 노드와 가장 가까운 네트워킹하는데 사용된다.
- MAC 주소란?
    2계층 통신을 위해 사용되는 주소로 노드의 고유 식별자다. NIC 카드에 명시되어 있음.
- IP 주소란
    해당 노드의 논리적인 주소. 3계층 통신을 위해 사용된다. 개인 IP를 공인 IP로 바꿀 때는 NAT 프로토콜이 사용된다.
    
    진행 방식은 클라이언트에서 게이트웨이를 통해 서버로 요청을 보내면 해당 IP로 찾아가서 브로드캐스팅을 통해 MAC 주소를 얻어낸다. 이후에 네트워킹할 때 해당 MAC 주소와 IP주소가 매핑되어 매번 ARP를 할 필요가 없어진다.
- TCP
    전송을 신뢰성 있게 하기 위해서 만들어진 프로토콜. 3way handshake를 통해 연결을 한다. 3way handshake로 연결이 보장되면 패킷을 순서대로 보낸다. 이 때 패킷은 1개씩 보내고 송수신을 매 번 체크한다. 이러한 방법은 여러 패킷을 보내는데 비효율적이므로 슬라이딩 윈도우 기법을 통해서 여러 패킷을 보냈을 때, 한 번만 확인할 수도 있다.
# 핵심 필기
## 3.1 유니캐스트, 멀티캐스트, 브로드캐스트, 애니캐스트

![Untitled 21.png](/img/user/image/Untitled%2021.png)
- **유니캐스트**: 1대1 통신을 위해 사용된다.
- **멀티캐스트**: 1대 그룹 통신을 위해 사용된다. 단방향으로 동시에 다수에게 동일한 내용을 보내야 할 때 사용된다.
- **브로드캐스트**: 1대 모든 통신을 위해 사용된다. ARP 같은 경우에 MAC 주소를 포함한 프레임을 네트워크에 속한 노드들에 보내고 노드들은 자신의 MAC 주소와 일치한 경우에 응답을 보냄으로써 주소를 알아낼 수 있다.
- **애니캐스트**: 1대1 통신이지만 그룹 중에서 가장 가까운 노드와 1대1 통신을 합니다. 가장 가까운 DNS 서버를 찾거나 가장 가까운 게이트웨이를 찾는 애니캐스트 게이트웨이 기능에 사용하기도 합니다.(AWS S3의 Multi Region Access Point나 DNS 서비스 등이 해당 통신을 사용할듯)

### **BUM(Broadcast Unknown uni-cast Multicast) 트래픽**
서로 다른 네트워크 전송 방식이지만 동일하게 동작합니다. Unknown Unicast의 경우엔 스위치에서 아직 목적지를 학습하지 못해서 연결된 모든 포트(프로세스의 포트 개념이 아니라 스위치 연결 포트를 의미함)에 플러딩하는 것을 말합니다. 이더넷 환경에서는 ARP 브로드캐스트를 통해 먼저 목적지를 학습한 후에 통신을 하므로 자주 발생하지 않습니다.

---
## 3.2 MAC 주소
네트워크 인터페이스 카드에 명시된 노드의 고유 번호입니다. 이더넷은 이를 이용해서 통신합니다.
제조사들에게 MAC 주소 풀을 주고 제조사는 이 풀에 속한 MAC 주소를 할당하여 제작합니다. 주소풀을 할당하는 것을 제조사 코드(Vendor Code)라고 부르며 이 주소는 국제 기구인 IEEE가 관리합니다.
48비트로 이루어져 있으며 16진수 12개로 이루어져 있습니다.
앞에 16진수 6개를 OUI 뒤에 3개를 UAA라고 합니다.
OUI의 경우엔 제조사의 코드이며 UAA는 각 제조사에서 할당한 값입니다.

### 3.2.2 MAC 주소 동작
ARP 프로토콜을 통해 해당 스위치에 연결된 모든 포트에 브로드캐스팅을 하면 노드들은 NIC에서 해당 패킷의 도착 목적지인 Mac 주소가 자기 자신과 일치하면 패킷을 받아들이고 상위레이어로 보냅니다. 반면에, 일치하지 않으면 패킷을 폐기합니다. 브로드캐스트의 경우 NIC에서 처리하는 것이 아닌 어플리케이션 레이어까지 무조건 패킷이 올라가므로 2계층 처리인 ARP에 비해서 부하가 심합니다.

자신이 속한 네트워크에 모든 패킷을 분석하기 위해서는 MAC 주소를 여러 개 가지는 방식으로 네트워크에 속한 모든 패킷을 수신하는 방법이 있습니다. Wireshark에선 무차별 모드(Promiscuous Mode)를 통해 이를 구현할 수 있습니다.

---
## 3.3 IP 주소
IP주소는 네트워크 주소와 호스트 주소를 사용합니다. 네트워크는 노드가 속한 네트워크의 주소를 말하며 끝자리는 0으로 끝납니다. 호스트 주소는 해당 네트워크에서 노드를 식별하는데 사용되는 주소입니다.

### 클래스 방식
8비트씩 나눠서 클래스로 네트워크를 할당하는 방식입니다.

### 클래스리스 방식(CIDE: Class Inter-domain Rouding)

서브넷마스크를 통해 네트워크를 더욱 유동적으로 사용하는 방식입니다.

A 클래스 네트워크가 8비트만 네트워크 주소로 사용하고 24비트는 호스트 네트워크로 사용됩니다. 그러나, 이처럼 고정된 비트를 할당하기보다는 동적으로 할당하는 방식이 더 주소 낭비가 없습니다.

예를 들어, 26비트를 네트워크 주소로 할당하고 6비트를 호스트 주소로 할당하면 일반 가정집에서 충분히 사용 가능합니다. 이를 서브넷마스크로 표현하면 (255.255.255.192: 11111111.11111111.11111111.11000000)이 됩니다.

### 서브네팅(P85)
원래 부여된 클래스의 기준을 무시하고 새로운 네트워크-호스트 구분 기준을 사용자가 정해 원래 클래스풀 단위의 네트워크보다 더 쪼개 사용하는 것을 서브네팅(Subnetting)이라고 합니다.

예시를 들어보자. 103.9.32.146 IP와 서브넷 마스크로 255.255.255.0을 준 네트워크가 있다고 보자. 노드의 개수가 255개보다 한참 적으므로 호스트 부분을 줄이기 위해서 2비트를 네트워크 주소로 더 준다고 해보자. 서브넷 마스크는 255.255.255.192가 된다.

위처럼 주어진 IP를 이용해서 새로운 네트워크를 만드는 게 서브네팅이다.

**네트워크 설계자 입장에서 서브넷팅**
설계자의 입장에서 IP를 설계할 때 고민할 부분은 다음과 같습니다.
1. 하나의 네트워크에 몇 개의 노드가 할당되는가?
2. 몇 개의 네트워크가 필요한가?
- **예제**
	회사가 가진 네트워크가 103.9.32.0/24 네트워크다.
	103.9.32.0/24는 네트워크 주소가 103.9.32.0
	브로드 캐스트 주소는 103.9.32.255 호스트 주소는 103.9.32.1 ~ 103.9.32.254가 된다.
	여기서 서브네팅은 이 전체 호스트 비트 범위를 서브네팅을 위한 IP로 사용하는 거다.
	
	만약, 이 회사엔 총 12곳의 지사가 필요하고 각 지사들에는 최대 12개의 IP가 필요하다.(노드가 12개)
	
	![image.TXHOQ2.png](/img/user/image/image.TXHOQ2.png)
	
	![Untitled 1 8.png](/img/user/image/Untitled%201%208.png)
	
	위의 과정은 103.9.32.0/24라는 제공 받은 IP에서 마지막 옥텟을 서브넷팅에 이용한 것이다. 마지막 8비트 중에서 4비트를 추가적으로 서브네팅을 위한 네트워크 주소로 사용하고 4비트를 호스트 주소로 사용한 것이다.
	
	![Untitled 2 6.png](/img/user/image/Untitled%202%206.png)
	
	위의 예시도 동일하다. 211.77.20.0이라는 네트워크 주소가 있고 마지막 8비트를 호스트 IP 주소로 할당하는 방식이다. 그런데 만약, 사용자가 여기서 네트워크를 더 나누고 싶다면 호스트로 할당된 비트를 추가적으로 네트워크로 할당하여 네트워크 분할이 가능하다.
	
	만약, 서브넷이 2개 필요하다면 호스트의 1비트를 추가적으로 할당한다.
	
	그렇게 되면 서브넷은 255.255.255.128이 된다.
	
	그렇게 되면 서브넷은 211.77.20.0으로 시작하며 211.77.20.01111111=211.77.20.127로 끝나는 서브넷이 되고
	
	또 다른 서브넷은 211.77.20.128로 시작하는 211.77.20.11111111=211.77.20.255로 끝나는 서브넷이 된다.
	
	결과적으로 현재 사용 가능한 IP를 2개의 네트워크와 126개의 노드(마지막은 브로드캐스트 IP 주소라)로 사용하는 것이다.

### 3.3.4 공인 IP와 사설 IP
인터넷에 접속하기 위해 사용되는 공인 IP는 유일한 IP입니다. 하지만 인터넷에 연결하지 않고 개인적으로 네트워크를 구성한다면 공인 IP 주소를 할당받지 않고도 네트워크를 구축할 수 있습니다. 우리가 공유기 설정 환경에서 192.168 혹은 172.16 등을 사용하는데 이는 공유기에서 제공하는 사설 IP 범위입니다. 노드에서 192.168.0.1과 같은 IP를 할당 받고 인터넷과 통신을 요청하면 공유기에선 이러한 사설 IP를 NAT를 거쳐서 공인 IP로 변경 후에 전송합니다.

![Untitled 3 5.png](/img/user/image/Untitled%203%205.png)

사설 IP로 할당된 IP의 범위는 RFC에서 공인한 표준 사설 IP이다. 따라서, 해당 IP로 요청은 내부 네트워크로 인지하고 요청을 한다. 만약, 이러한 표준 사설 IP가 아닌 다른 IP를 사용하면 NAT 과정에서 해당 범위를 내부 IP로 취급하여 해당 내부 IP를 가진 외부 서버엔 요청이 불가능해질 수도 있다.

![image.HWOHQ2.png](/img/user/image/image.HWOHQ2.png)


---
## 3.4 TCP와 UDP(P96)

### 3.4.1 4계층 프로토콜(TCP, UDP)과 서비스 포트

이전에 인캡슐레이션과 디캡슐레이션 과정에서 추가되는 정보가 2가지가 있다고 말했습니다.

1. 상위 프로토콜 지시자
2. 해당 계층에서 정의하는 정보

![Untitled 4 5.png](/img/user/image/Untitled%204%205.png)

TCP/IP 프로토콜 스택에서 4계층의 상위 프로토콜 지시자는 포트 번호입니다.

![Untitled 5 3.png](/img/user/image/Untitled%205%203.png)
### 3.4.2 TCP

TCP의 핵심 헤더 요소는 패킷 번호(SEQ), 응답 번호(ACK), 전송 크기(Window Size)입니다.

- SEQ, ACK
	
	![Untitled 6 3.png](/img/user/image/Untitled%206%203.png)
	
	패킷을 보낼 때, 수신자는 SEQ 번호를 통해 데이터를 조립합니다.
	
	수신자는 데이터를 수신하고 ACK를 전송하여 데이터를 받았음을 알립니다. 송신자는 ACK를 받고 다음 패킷을 보냅니다. 이 때, **ACK의 값**은 **수신한 데이터의 SEQ값 + 데이터의 크기**입니다.
	
	패킷을 받은 노드는 요청하는 다음 SEQ 번호를 ACK 번호로 보냅니다.
	
	![Untitled 7 3.png](/img/user/image/Untitled%207%203.png)
	
- 윈도우 사이즈
	그러나, 위처럼 매 번 수신지로부터 ACK가 도착하기 전까지 기다리려면 굉장히 긴 대기 시간이 발생합니다. 수신측과 거리가 먼 경우, RTT가 길어지고 이에 비례해서 더욱 느려질 것입니다.
	그래서 윈도우 사이즈를 사용합니다. 송신자는 윈도우 사이즈 개수만큼 패킷을 보낸 후에 ACK를 수신합니다.
	![Untitled 8 3.png](/img/user/image/Untitled%208%203.png)
	위에 보면 알 수 있듯이 윈도우 사이즈의 크기는 16비트이므로 2^16로 대략 64k입니다. 이는 현대 네트워크에서 너무 작습니다. 헤더 사이즈를 변경하는 것은 불가능하므로 뒤의 숫자를 무시하는 방법으로 윈도 사이즈를 증가시킵니다.
	
- 3방항 핸드셰이크
	TCP에서는 정확한 통신을 위해서 **패킷을 3번 주고 받는 준비 과정**을 거칩니다. 이를 3-way handshake라고 합니다.
	
	![Untitled 9 2.png](/img/user/image/Untitled%209%202.png)
	핸드셰이크로 인해 이번 통신이 어떤 과정에 있는지(Syn, Syn Ack, Ack 중 어떤 통신인지) 확인을 위해 헤더값에 플래그 값을 사용합니다.
	
	![Untitled 10 2.png](/img/user/image/Untitled%2010%202.png)
		

### 3.4.3 UDP
실시간 스트리밍처럼 시간에 민감한 프로토콜이나 멀티캐스트처럼 단방향으로 다수의 단말과 통신해 응답을 받기 어려운 환경에서 사용합니다. 단, 넷플릭스나 유튜브와 같이 시간에 민감하지 않은 단일 시청자를 위한 연결은 TCP를 통해 수 초 ~ 수 분의 동영상 데이터를 미리 받아 놓고 캐시에 저장합니다.

![Untitled 11 2.png](/img/user/image/Untitled%2011%202.png)

![Untitled 12 2.png](/img/user/image/Untitled%2012%202.png)

## 3.5 ARP(P110)

### ARP(Address Resolution Protocol)

ARP는 MAC 주소를 알아내기 위해 사용되는 프로토콜.

![Untitled 13 2.png](/img/user/image/Untitled%2013%202.png)

ARP를 사용해서 MAC 주소를 알아낸다. 이를 캐시에 저장해두고 캡슐화할 때 MAC 주소를 사용한다. 패킷을 상대방의 네트워크에 브로드캐스트(브로드캐스트용 MAC 주소 FF-FF-FF-FF-FF-FF)하고 응답을 받음으로써 상대방의 MAC 주소를 알아낸다.

![Untitled 14 2.png](/img/user/image/Untitled%2014%202.png)

	

	

![Untitled 15 2.png](/img/user/image/Untitled%2015%202.png)

	

![Untitled 16 2.png](/img/user/image/Untitled%2016%202.png)

### 3.5.3 GARP(Gratuitous ARP)

ARP가 상대방의 MAC 주소와 IP 주소를 테이블에 저장하기 위해 사용하는 것과는 달리 GARP는 자신의 MAC 주소와 IP 주소를 알리기 위해 사용된다.

**사용되는 이유**

1. IP 주소 충돌 감지
2. 상대방(동일 서브넷 상의 다른)의 ARP 테이블 갱신
3. HA(고가용성) 용도의 클러스터링, VRRP, HSRP

### 3.5.4 RARP(Reverse ARP)
IP 주소로부터 MAC 주소를 얻는 ARP와 반대로 MAC 주소로부터 IP 주소를 얻는다.
IP 주소를 할당 받지 못한 노드가 IP를 할당 받기 위해 사용된 프로토콜이지만 현재는 DHCP, BOOTP로 대체되었다.

## 3.6 서브넷과 게이트웨이

동일 네트워크 내에선 네트워크 동작 방식이나 필요한 네트워크 장비가 동일합니다. 인터넷을 통해 통신을 할 때는 외부 네트워크와 통신을 하는데 이 때는 로컬 네트워크와 동작 방식이나 사용하는 네트워크가 다릅니다. 이를 해결하기 위해 사용되는 것이 게이트웨이입니다. 3계층 장비(라우터, L3 스위치)가 이 역할을 할 수 있습니다.

브로드캐스트의 경우 로컬 네트워크에서만 가능하고 원격 네트워크에 브로드캐스팅을 하기 위해선 게이트웨이의 도움이 필요하다.

### 3.6.2 2계층 통신 vs 3계층 통신
로컬네트워크 간에 통신에는 ARP로 브로드캐스팅을 통해 MAC 주소를 알아내기만 해도 통신이 가능합니다. 따라서, 3계층인 IP가 필요하지 않습니다. 이를 **L2 통신**이라고 합니다.
반면에, 원격 네트워크와 통신을 위해서는 라우터가 없인 불가능합니다. 이를 **L3 통신**이라고 합니다.
이는 ARP가 원격 네트워크와 로컬 네트워크에서 동작하는 방식에 차이 때문입니다. 브로드캐스트는 로컬 네트워크 내에서만 동작이 가능하고 원격 네트워크에 브로드캐스팅을 요청하기 위해서는 게이트웨이에 요청을 해야 합니다. 따라서, 로컬에선 L2만으로 동작이 가능하고 원격에선 게이트웨이가 필요하므로 L3 통신이 되는 것입니다.