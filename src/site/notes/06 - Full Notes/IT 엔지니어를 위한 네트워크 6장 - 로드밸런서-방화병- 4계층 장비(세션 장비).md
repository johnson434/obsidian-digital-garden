---
{"dg-publish":true,"permalink":"/06-full-notes/it-6-4/","noteIcon":""}
---

[[03 - Tags/IT Engineer를 위한 네트워크\|IT Engineer를 위한 네트워크]]
# 핵심 요약
4계층에서는 지금까지 신경 쓰지 않았던 통신의 방향이나 순서 등을 신경 쓴다. 이를 위해 필요한 정보들을 세션 테이블에서 관리한다.

세션 장비는 로드밸런서, 방화벽 역할을 합니다. 세션 테이블에 일정 시간동안 요청이 들어온 패킷들의 정보를 저장해놓고 일정 시간이 지나면 이를 지웁니다.

로드밸런서는 작업을 분산하는 역할을 합니다. L4 로드밸런서와 L7 로드 밸런서가 있는데 로드밸런싱을 위해 어떤 계층을 이용하냐에 따라 달라집니다.

방화벽은 네트워크 사이에 존재하며 지나가는 패킷들을 필터링합니다.

대칭 경로는 인바운드 패킷과 아웃바운드 패킷이 동일한 세션 장비를 지나는 것을 말합니다. 동일한 세션 장비를 지나므로 세션 테이블에 정보가 존재하지 않아서 문제가 발생할 일은 없습니다.

비대칭 경로는 인바운드 패킷과 아웃바운드 패킷이 서로 다른 세션 장비를 지나는 것을 말합니다. 서로 다른 세션 장비이기 때문에 서로 다른 세션 테이블을 가지므로 이로 인해 비대칭 경로를 지나온 패킷이 폐기 되는 상황도 발생할 수 있습니다. 이를 해결하기 위해서 세션 장비 간에 세션 테이블을 동기화하거나 세션 테이블에 존재하지 않으면 다른 세션 장비에 요청을 리다이렉팅 하는 방식으로 처리할 수 있습니다.
# 단서 질문
- 4계층에서 사용되는 요소들
    **포트**: 스위치의 포트와는 다른 단일 노드에 식별자로 어플리케이션과 매칭되어 패킷을 수신한다.
    **SEQ**: 패킷의 전송 순서다.
    **ACK**: 패킷의 수신 순서다.
- 방화벽이란
    네트워크 사이에 존재하며 지나가는 패킷들을 필터링하는 하드웨어나 소프트웨어
- L4 스위치와 L7 스위치
    둘다 4계층 세션 장비로 사용하는 계층이 L4인지 L7인지에 따라 다릅니다.
    L4는 TCP UDP 정보를 활용합니다.
    L7은 애플리케이션 프로토콜을 활용합니다. 이를 통해 애플리케이션의 이해도가 높으므로 이미지 캐싱이나 데이터 압축 등으로 애플리케이션의 작업을 보완할 수 있습니다.
- 로드밸런서란
    작업들을 나눠서 서버에 부하가 적게 오도록 합니다.
- 세션 장비란
    세션 테이블에 패킷들의 송신지 수신지 등을 저장합니다. 이를 통해 통신이 오면 이것이 이전에 요청이 왔던 요청인지 파악이 가능합니다. 만약, 세션 테이블에 존재하지 않는데 ACK 패킷이 온다면 이를 폐기합니다.(기본 설정으로 보완 가능)
    TCP 3way handshake 과정에서도 SYN, SYN/ACK, ACK 모두 세션 테이블에 기록됩니다.
    

# 핵심 필기
### 6.1 4계층 장비의 특징

4계층에서 가장 중요한 것은 세션입니다. 따라서, 4계층 장비들을 세션 장비라고도 말합니다.

세션 장비에서 가장 중요한 것은 다음 **3가지**입니다.

1. **세션 테이블**
2. **Symmetric(대칭) 경로**
3. **정보변경(로드밸런서의 경우)**

## 6.2 로드 밸런서
로드밸런서는 작업에 부하가 왔을 때, 작업을 분산함으로써 부하 정도를 낮추는 역할을 합니다.
일반적으로 웹서버의 트래픽을 로드밸런서를 통해 분산하여 서버에 트래픽을 낮춥니다.

**L4 로드 밸런서**
4계층인 TCP, UDP의 정보(특히 포트 번호를 자주 활용)를 활용하여 로드밸런싱한다. 최근 로드밸런서 하드웨어들은 대부분 L4, L7 둘 다 지원한다. 장비의 상관 없이 4계층의 정보만으로 로드밸런싱을 하면 L4 로드 밸런서라고 한다.[^1]

**L7 로드 밸런서**
7계층인 Application 프로토콜(HTTP, SMTP 등)의 정보를 통해 로드밸런싱한다.
> [!important]  
> L4/L7 로드밸런서는 둘 중 뭘 택하냐에 따라 나뉘지만 AWS에선 이를 계층 별로 나눠서 서비스를 하고 있다. NLB(Network Load Balancer)와 ALB(Application Load Balancer)다.  

### **L4 스위치**
4계층에서 동작하는 스위치로 일반 스위치와 동일한 외형을 가졌습니다.. L4 로드밸런서로는 소프트웨어형 로드밸런서, 서버형 로드밸런서 등이 있지만 L4 스위치를 가장 많이 사용합니다.
L4 스위치는 부하 분산, 성능 최적화, 리다이렉션 기능을 제공합니다.
### ==**ADC(Application Delivery Controller)**==
L7 계층에서 동작하는 로드밸런서로 L4 스위치의 기능에 더해서 7계층의 요소를 활용할 수 있습니다. 어플리케이션의 헤더나 프로토콜을 통해 ==필터링, 로드밸런싱, 부하 분산 등이 가능==합니다. 이외에도 애플리케이션 프로토콜을 이해하기 때문에 압축, 캐싱, 콘텐츠 변환, 인코딩 변환 등이 가능하며 플러그인으로 WAF(Web Application Firewall), HTML XML 검증 등이 가능합니다. 이미지 캐싱 또한 가능합니다.

## 6.3 방화벽
네트워크와 네트워크 사이에 존재하며 3계층 4계층에서 동작한다. 네트워크 사이에 지나가는 패킷을 필터링하는 하드웨어나 소프트웨어를 의미한다.
세션 테이블을 사용하여 사용자가 요청을 먼저 했는지 이에 대한 응답인지를 파악할 수 있습니다.
> [!important]  
> 세션 테이블? 상태 테이블? 동일한 용어로 방화벽을 통해 들어오는 패킷들의 정보를 저장하는 테이블  

## 6.4 4계층 장비를 통과할 때의 유의점(세션 관리)
세션 장비는 세션 테이블을 이용해 지나가는 패킷을 압축하거나 필터링하여 애플리케이션의 성능을 보완할 수 있습니다. 애플리케이션에서도 세션 테이블을 활용하여 여러 가지 작업을 할 수 있습니다. 따라서, 애플리케이션 개발자는 세션 장비의 세션 테이블의 설정에 맞춰 코드를 작성해야 합니다.

### 6.4.1 세션 테이블 유지 및 동기화
서버 노드 ↔ 세션 장비(L4 장비, 세션 장비) ↔ 인터넷 ↔ 클라이언트
세션 장비에선 세션 테이블을 특정 시간 유지하다가 시간이 지나면 테이블의 내용을 지웁니다. 그런데 만약에 세션 장비의 테이블은 지워졌는데 서버 애플리케이션에서의 세션 시간은 지나지 않아서 패킷을 세션 장비에 보낸다거나 혹은 클라이언트에서 서버의 패킷을 보내면서 세션 장비를 거친다면 어떻게 될까요?
우선 세션 장비에선 들어오는 패킷(ACK)에 대해서 세션 테이블에 검색을 할 것입니다. 그런데 이미 세션 장비에서 설정한 타임 아웃이 지나서 세션 장비에선 이 패킷을 폐기할 것입니다.
![Untitled 28.png](/img/user/image/Untitled%2028.png)

**네트워크 엔지니어가 문제를 해결하는 방법**
1. 세션 타임 아웃을 세션 장비와 Application에서 동일하게 설정한다. → 애플리케이션 개발자와 소통 필수
2. 세션 테이블에 없어도 ACK 신호를 수신하도록 설정한다. → 보안 문제
3. 세션 만료 시 세션 장비에서 서버와 클라이언트에 통보

**어플리케이션 개발자가 문제를 해결하는 방법**
1. 주기적으로 패킷을 송신한다. 세션 테이블을 특정 시간동안 패킷이 오지 않는 정보만 지우므로 더미 패킷을 송신하여 세션 타임아웃이 발생하기 이전에 네트워킹한다.
### 6.4.2 비대칭 경로 문제

세션 장비로 들어오는 인바운드 패킷과 아웃바운드 패킷의 경로가 다르면 **비대칭 경로(Asymmetric Path)**이라고 하고 동일하면 **대칭 경로(Symmetric Path)**라고 한다.

![Untitled 1 15.png](/img/user/image/Untitled%201%2015.png)

![Untitled 2 13.png](/img/user/image/Untitled%202%2013.png)

위처럼 비대칭 경로가 발생하면 세션 테이블에 정보가 없는 패킷이 ACK로 응답이 나가므로 다른 세션 장비에선 이 패킷을 버립니다.

이를 해결하는 방법은 2가지 있습니다.
1. **세션 테이블 동기화**
두 테이블의 세션 테이블 정보를 동기화합니다. 단점으로는 동기화 전에 패킷이 나가면 아무 의미가 없습니다.
1. **패킷 리다이렉팅**
자신의 세션 테이블에 존재하지 않으면 해당 응답을 다른 세션 장비로 리다이렉팅합니다.
### 6.4.3 하나의 통신에 두 개 이상의 세션이 사용될 때(스킵)

[^1]: AWS의 Network Loadbalancer(NLB)가 4계층 로드밸런서에 속하고 Application Loadbalancer(ALB)가 7계층 로드밸런서에 속합니다. ALB가 경로 기반이나 쿼리스트링 기반 로드밸런싱이 가능한 이유가 이러한 7계층 기반 로드밸런싱이 가능하기 때문입니다.
