---
{"dg-publish":true,"permalink":"/06-full-notes/it-7/","noteIcon":""}
---

[[03 - Tags/IT Engineer를 위한 네트워크\|IT Engineer를 위한 네트워크]]
# 단서 질문
- NAT란?
    NAT(Network Address Translation)은 IP를 변환해서 패킷을 재전송하기 위해서 사용되는 프로토콜입니다.
    
    흔히 사용자의 개인 IP를 공인 IP로 변환하거나 쿠버네티스 내에선 파드로 재전송하기 위해서 NAT 프로토콜을 사용합니다.
    
- DNS란?
    도메인과 일치하는 IP 주소를 반환하는 서비스
    
- [www.naver.com](http://www.naver.com) 질의 시 진행 과정
    1. DNS 캐시를 확인하고 naver.com과 일치하는 도메인이 있는지 도메인 서버에 질의
    2. 도메인 서버는 Root 도메인 서버에 질의
    3. Root 도메인 서비스는 TLD(Top Level Domain e.g: .com, .kr) 도메인 서버 주소를 돌려준다.
    4. .com DNS 서버에선 .com 도메인에 서브 도메인인 도메인(naver.com) 서버 주소를 돌려준다.
    5. [naver.com](http://naver.com) 도메인은 IP 주소를 도메인 서버에 돌려준다.
    6. 도메인 서버에선 요청한 클라이언트에게 해당하는 IP 주소를 돌려준다.
    7. 클라이언트는 받은 IP 주소를 통해 서버에 접속한다.
# 핵심 요약
- NAT란 네트워크 주소를 번역해주는 기능이다.
- 개인 IP와 공인 IP에 한정되는 기술이 아니다. 쿠버네티스에서 노드포트 서비스 등은 이러한 NAT 프로토콜을 통해 구현된다.
- NAT를 통해 IP 주소를 아낄 수 있습니다.
- 패킷 수신자는 NAT 장비까지의 주소만 알 수 있을뿐 송신자의 실제 주소를 알지 못합니다.
- NAT는 주소만 변환하며 PAT는 포트도 변경합니다. 따라서, 하나의 IP에 더 많은 주소 할당이 가능합니다.
- DNS란? 도메인과 매핑되는 IP 주소를 반환합니다.

# 핵심 필기
## NAT/PAT
NAT(Network Address Translation)란? 3계층인 라우팅 계층에서도 쓰이고 4계층인 세션 장비에서도 빈번하게 사용됩니다.

사용 예로는 사설 IP를 공인 IP로 번역하거나 공인 IP를 사설 IP로 번역하기. 또는 4계층에서 로드밸런서를 통해 요청했던 IP가 아닌 적합한 노드의 IP로 리다이렉팅하기 위해서 IP를 변환하는 등의 사용 예시가 있습니다.

스위치를 통해 노드의 부여되는 주소들은 NAPT(Network Adress Port Translation)으로 부여 받으며 이를 현업에선 PAT(Port Address Translation)이라고 부릅니다.

### **7.1.1 NAT/PAT 용도와 필요성**
- **1. IP 주소 고갈의 문제**
	IPv4는 32bit로 2^32 개수밖에 할당하지 못합니다. 이를 해결하기 위해서 초창기 대응이 서브네팅이고 이후엔 NAT와 사설 IP, 가장 마지막 대응은 IPv6로 전환입니다.
	
	서브네팅은 서브넷 마스크를 통해 사용 가능한 IP를 더 효율적으로 나누는 역할이었습니다.
	
	NAT의 경우엔 NAPT를 통해서 노드에게 사설 IP를 할당하고 외부와 통신을 할 때는 NAT 프로토콜을 통해서 사설 IP를 공인 IP로 변환해서 통신합니다. 이를 통해서 인터넷에선 단 하나의 IP만 사용하고도 연결된 노드들이 모두 통신할 수 있습니다.
	
	마지막으로 IPv6는 근본적인 해결책으로 네트워크 주소를 위한 비트. 즉, 전체 데이터 크기를 늘리는 것입니다. IPv6는 128비트입니다.
- **2. 보안을 강화한다.**
	내부 IP를 공인 IP로 변환한 후에 통신을 하므로 인터넷에서 네트워킹을 하는 상대방은 해당 네트워크의 내부 IP 주소 체계를 알 수 없다. 따라서, 이를 통해 내부 구조 파악을 하지 못한다.
- **3. IP 주소 체계가 같은 두 개의 네트워크 간에 통신을 가능하게 해준다.**
	동일한 내부 IP 체계를 사용하는 경우, 예를 들어 192.168.0.0에 서브넷 마스크가 255.255.255.0인 네트워크가 두 개가 있습니다. A 네트워크에서 192.168.0.1 주소를 가진 노드와 B 네트워크에서 192.168.0.1 주소를 가진 노드가 통신을 하기 위해서 NAT가 사용됩니다. 이 때는 송신지와 수신지 모두 NAT가 이뤄져야하므로 Double NAT라고 합니다.
- **4. 불필요한 설정 변경을 줄일 수 있다**
	인터넷 회선을 변경하거나 ISP를 변경하거나 서버의 지역을 옮겨나 공인 IP의 주소가 변경되더라도 NAT/PAT를 통해 구축한 네트워크는 내부 IP를 사용하므로 내부 IP 설정을 변경할 필요가 없습니다.
### **7.1.2 NAT 동작 방식**

![Untitled 33.png](/img/user/image/Untitled%2033.png)
위의 그림은 NAT가 동작하는 방식으로 IP의 주소 변환이 NAT 장비에서 일어나고 해당 주소로 요청이 들어오면 다시 역변환을 통해 원래 IP의 노드에게 데이터를 전달한다.

### **7.1.3 PAT 동작 방식**

**PAT**

![Untitled 1 19.png](/img/user/image/Untitled%201%2019.png)

NAT 방식과 동일하게 IP를 변경하지만 PAT는 포트 주소 또한 변경합니다.

![Untitled 2 17.png](/img/user/image/Untitled%202%2017.png)

PAT 방식은 포트를 변경하기 때문에 하나의 공인 IP에 여러 개의 사설 IP가 할당될 수 있습니다.

192.168.0.1:30 →111.111.111.111:328

192.168.0.2:30 →111.111.111.111:329

따라서, 외부에서 만약에 111.111.111.111 IP로 요청을 보내면 어떤 사용자한테 요청을 보내야할지 알 수 없습니다.

따라서, PAT은 SNAT에서만 사용 가능합니다.

### **7.1.4 SNAT와 DNAT**

SNAT(Source NAT)와 DNAT(Destination NAT)는 출발지를 변환하는 경우와 도착지를 변환하는 경우입니다.

![Untitled 3 14.png](/img/user/image/Untitled%203%2014.png)

**SNAT**는 사설 IP가 공인 IP와 통신할 때, 사용됩니다. 노드가 사용하는 IP를 공인 IP로 변경하여 해당 공인 IP로 응답을 받습니다.

**DNAT**는 로드밸런서를 위해 많이 사용됩니다. 로드밸런서에서 실제 서버의 주소로 도착지 주소를 변경하여 패킷을 전송합니다.

### **7.1.5 동적 NAT와 정적 NAT**
**동적 NAT**
변환될 IP가 고정되어 있지 않고 일정 IP 레인지에서 IP를 할당 받습니다.

**정적 NAT**
변환될 IP가 고정되어 있으며 1대1로 매핑되어 있습니다.

![Untitled 4 13.png](/img/user/image/Untitled%204%2013.png)
## DNS
- **개요**
	프로토콜엔 두 가지 종류가 있습니다. 실제로 데이터를 전송하는 역할을 하는 데이터 프로토콜(Data Protocol)과 전송을 하기 위한 설정을 유지하는 역할을 하는 컨트롤 프로토콜(Control Protocol)이 있습니다.
	이번엔 컨트롤 프로토콜에 속하는 ICMP, ARP, DNS 중에서 DNS를 다룹니다.

### **7.2.1 DNS 소개**
DNS는 요청하는 ==도메인의 주소와 매핑되는 IP 주소를 돌려주는 서비스==입니다.
이러한 서비스가 있기 때문에 우리는 매 번 사이트의 주소를 외우지 않아도 됩니다.

### **7.2.2 DNS 구조와 명명 규칙**
도메인은 뒤에서부터 내려오는 트리 구조입니다.
www.naver.com이라는 주소를 보면 이 주소는 [www].[naver].[com].이라는 구조로 되어 있습니다.
맨 마지막 .을 루트 com을 first-level naver를 second-level www를 third-level이라고 합니다.
도메인은 영어 소문자, 숫자, ‘-’를 사용 가능합니다.

**7.2.2.1 루트 도메인**
도메인 서버는 해당 도메인에 대한 IP 주소를 캐싱하고 있으면 바로 응답하고 가지고 있지 않으면 루트 도메인에 질의합니다. 이를 통해 매핑되는 IP 주소를 리턴합니다.
		
**7.2.2.2 탑 레벨 도메인(TLD) 자세한 내용 생략**
탑 레벨 도메인은 밑에 6종류가 있습니다.
![Untitled 5 10.png](/img/user/image/Untitled%205%2010.png)
### **7.2.3 DNS 동작 방식**
클라이언트에선 DNS 캐시를 먼저 확인하고 해당 도메인과 일치하는 주소를 찾습니다. 만약, 여기서 일치하는 주소가 없으면 도메인 서버에 요청을 합니다.
이와 같이 클라이언트와 DNS 서버 사이의 요청을 **재귀적 쿼리**라고 합니다.
DNS 서버와 Root NS, TLD NS 등에게 하는 쿼리는 **반복적 쿼리**라고 합니다.

![Untitled 6 9.png](/img/user/image/Untitled%206%209.png)

### **7.2.4 마스터와 슬레이브**
DNS 서버는 도메인 정보를 가지고 있는(이를 존 Zone이라고 한다) 마스터 서버와 해당 존을 복제한 슬레이브 서버가 있다. 일반 이중화 서버가 사용하는 방식인 Active-Active나 Active-StandBy가 Active 서버의 문제가 발생하면 Active나 StandBy 서버가 역할을 대신 하는 데에 반해 DNS의 마스터 서버와의 연결이 끊기면 슬레이브도 DNS 역할을 하지 못합니다. 이를 복구하기 위해선 슬레이브 서버를 마스터 서버로 바꾸거나 마스터 서버의 설정을 복구해야 합니다.

### **7.2.5 DNS 주요 레코드(스킵)**
### **7.2.6 DNS에서 알아두면 좋은 내용(스킵)**
## GSLB
- **개요**
	==DNS는 하나의 도메인에 여러 개의 IP를 필드값으로 가질 수 있습니다.== 이를 통해 로드밸런싱이 가능합니다.
	
	그러나, 이들은 도메인에 속한 IP의 ==서버 상태가 응답이 불가능한 상태더라도 해당하는 서버의 IP를 리턴==합니다. 따라서, 사용자는 제대로 동작하지 않는 서버의 IP를 받게 됩니다.
	
	이러한 문제점을 개선한 로드밸런서를 ==**GSLB(Global Server/Service LoadBalancer)**==라고 합니다. GSLB는 해당하는 도메인의 IP와 일치하는 서버들의 헬스 체크를 하고 문제가 없는 IP 주소를 리턴합니다.
	
### **7.3.1 GSLB의 동작 방식**
클라이언트에서 DNS 캐싱을 확인합니다. 일치하는 도메인이 없으므로 루트 서버에 질의합니다. 루트 서버는 퍼스트 도메인에 질의하고 퍼스트 도메인에선 서브 도메인 서버에 질의해서 응답을 받습니다. 도메인 서버는 최종적으로 받은 결과를 클라이언트에 반환합니다.