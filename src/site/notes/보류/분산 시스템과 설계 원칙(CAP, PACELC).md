---
{"dg-publish":true,"permalink":"//cap-pacelc/","noteIcon":""}
---

[[03 - Tags/작성 중인 문서\|작성 중인 문서]]]

아래 내용은 개인적으로 분산 시스템, CAP, PACELC에 대한 생각을 정리한 내용입니다.
틀린 내용이 있다면 댓글로 알려주시면 감사하겠습니다.
## 분산 시스템이란?
우선, CAP에 대해 다루기 전에 분산 시스템에 대해 정의하고 들어가겠습니다.
분산 시스템은 공통의 공유 목표를 달성하기 위해 여러 개의 분리된 노드에 걸쳐 계산 리소스를 활용하는 컴퓨터 프로그램 모음입니다.[^1]
예로 DocumentDB의 읽기 전용 복제본이나 Redis cluster 등이 있습니다.
## 분산 시스템을 왜 쓸까?
그렇다면 분산 시스템을 왜 쓰냐? 분산 시스템은 가용성과 확장성. 그 중에서도 확장성에 아주 유리한 시스템입니다.
예를 들어, 한 스타트업에서 웹서비스를 만들었습니다. 해당 웹서비스는 시장이 크지 않습니다. 해당 회사에서도 해당 서비스를 중점적으로 홍보할 예정은 없습니다.
따라서, 가용성과 확장성을 크게 고려하지 않은 서비스를 구축했습니다.[^2]
![Pasted image 20250226193636.png](/img/user/image/Pasted%20image%2020250226193636.png)
Web 계층은 ASG(Autoscaling Group)를 사용합니다. ASG는 서버의 개수를 관찰하며 해당 서버의 개수를 1대로 유지합니다. 따라서, 서버에 장애가 발생한다면 서버를 새로 시작합니다. 그러나, 서버가 복구 되는 과정에서 유저는 서비스 이용이 불가능합니다.
Data 계층에서 RDS는 DR을 구축하지 않았으며, 데이터베이스가 다운되면 서비스 이용이 불가능합니다.

이제 유저 수가 점점 늘기 시작한다고 가정하겠습니다. 
회사에선 해당 서비스를 지원하여 더 많은 유저 수를 수용하기 원합니다.
따라서, 아키텍처가 다음과 같이 변경됐습니다.
![Pasted image 20250226194821.png](/img/user/image/Pasted%20image%2020250226194821.png)
Web 계층은 Web 서버가 무상태(stateless)[^3]이므로 수평적 스케일링을 진행하고 이를 위한 단일 엔드포인트이자 작업 분배를 위해서 로드밸런서가 배치됩니다.
Data 계층은 Web 계층과 동일한 진행이 힘듭니다. Data 계층은 데이터를 저장하므로 상태를 가지고 있습니다. 그러므로 서버의 개수가 늘어나면 해당 서버들 간에 데이터 동기화가 필수적입니다.
문제를 간단하게 해결하기 위해서 DB 서버는 동기화가 필요 없는 수직적 스케일링을 진행했습니다. 수직적 스케일링 진행하는 동안엔 웹페이지의 점검 시간을 표시하여 

유저 수가 더욱 증가하면 어떻게 될까요? Web 계층은 수평적 스케일링을 통해서 충분히 처리가 가능합니다. 그러나, DB는 수직적 스케일링을 다시 진행할 필요가 있습니다. 해당 스케일링동안에 

이러한 경우에 분산 시스템은 좋은 해결 방법입니다. 
위에선 Data 계층이 수평적 스케일링이 불가능하다고 했지만 분산 시스템으로 설계하면 가능합니다.
![Pasted image 20250226202736.png](/img/user/image/Pasted%20image%2020250226202736.png)
분산 

거기에 사용되는 정리가 CAP 정리입니다.
## CAP
CAP란? **C**onsistency **A**vailability **P**aritition tolerance의 앞 글자를 딴 이론입니다.
Consistency는 일관성으로 동일한 시간에 들어온 요청에 대해서 동일한 데이터를 응답합니다.
Availability는 가용성으로 분산 시스템의 특정 노드가 죽더라도 서비스 제공이 가능합니다.
Partition tolerance는 분산 시스템의 노드 간에 장애가 발생하여 네트워크 단절이 나타났음에도 서비스 제공이 가능함을 의미합니다.[^4]
CAP 정리는 분산시스템을 설계하면 이 두 가지 중에서 2개만 제공 가능함을 의미합니다.
이제 이전 아키텍처를 보겠습니다.
![Pasted image 20250226202736.png](/img/user/image/Pasted%20image%2020250226202736.png)
아까도 말했듯이 데이터 가지고 있으니까 여러 서버 안된다며. 그런데 됩니다.
왜냐? 분산 시스템은 이를 해결하기 위한 CAP 전략이 있으니까.
데이터 동기화(비동기 혹은 동기)를 통해서 서로 다른 DBMS 간에 데이터를 일치시켜 어떤 서버로부터 요청이 와도 동일한 데이터를 응답 받습니다.
그럼 무조건 Consistency는 제공하네? 무조건 데이터가 동기화 되니까? 반은 맞고 반은 틀립니다. 데이터 동기화를 비동기식으로 진행할 경우엔 Master 서버와 Slave 서버의 데이터가 일치하지 않을 수 있습니다. 동기식의 경우엔 Master 서버의 데이터를 Slave에 작성한 이후에 요청을 처리하지만 비동기식의 경우엔 Master가 Slave 서버에 작성하지 않더라도 바로 다음 작업으로 넘어갑니다.
여기서 일관성을 어디까지 보장하냐는 문제가 나옵니다.
사실 일관성에 너무 집착하지 않아도 됩니다. 은행 같은 금융서비스처럼 데이터의 일관성이 중요한 곳 이외에는 데이터의 일관성이 크게 중요하지 않을 수도 있습니다.
예를 들어, 인스타에 누가 글을 썼는데 순간적으로 어떤 DB엔 데이터가 있고 어떤 DB엔 데이터가 없다. 그런데 이게 문제가 될까요? 사용자 경험에서 차이가 있다고 주장할 수도 있겠지만 이는 ms에서 길어도 수 초 내에 동일한 데이터를 반환합니다. 따라서, 완벽한 데이터 일관성을 보장하지 않고 성능상 이점을 갖는 것도 하나의 방법입니다.
Consistency 전략을 수립하여 서로 다른 서버 간에 데이터를 동기화 시킬 수 있습니다.



가용성은 MultiAZ도 되니까

CAP가 말이 안되는 이유
애초에 P는 네트워크 장애가 발생했음을 가정하는 기능임.
그런데, P를 제공하지 않는다. => 네트워크 장애가 발생했을 때, 서로 다른 노드 간에 통신이 불가능하다 => 그런데 서로 다른 분산 시스템의 CA 제공이 가능하다. => ? 분산 시스템 노드 간에 통신이 안되는데 서로 다른 노드의 데이터를 어떻게 동기화(consistency)할건데?
그래서 찾아보니까 CA는 이상적인 분산 시스템 구조다.
CA는 P가 없는 게 아니라. Partition이 존재하지 않는 네트워크를 가정한 상태에서 설계 가능한 분산 시스템을 의미한다.

애초에 Partition을 능력처럼 설명한 게 문제 같다.
Partition은 시스템이 처한 상황인데 문맥이 좀 이상하다.
# PACELC
그래서 나온 방법이 PACELC
Partition 상태에선 Availability와 Consistency 둘 중에 하나 선택
Else 상태에선 Latency와 Consistency 둘 중에 하나 선택

# 참고 자료
- http://eincs.com/2013/07/misleading-and-truth-of-cap-theorem/
# 주석

[^1]: https://www.atlassian.com/microservices/microservices-architecture/distributed-architecture

[^2]: 작은 서비스에도 가용성과 확장성을 고려할 필요가 있다고 생각할 수도 있겠지만, 현실적으로 생각하면 비용 측면에서 타협을 할 필요가 있습니다. Application 계층의 확장성을 고려하여 무상태(stateless)로 만들면 추후에 확장도 그렇게 어렵지 않을까 생각합니다.

[^3]: 웹서버가 상태를 가지고 있지 않으면 다른 노드로 요청이 가더라도  데이터 일관성 문제가 생기지 않는다. 혹은 sticky session을 통해 클라이언트가 동일한 노드로 요청을 보내도록 서버를 고정할 필요가 있다.

[^4]: 이건 내 생각인데 네트워크가 두 부분으로 나뉜다. 그래서 파티션에 내성이 있다. 이런 식으로 작명한 느낌같다. 이건 추측이고
