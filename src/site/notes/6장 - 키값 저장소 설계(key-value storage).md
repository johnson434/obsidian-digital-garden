---
{"dg-publish":true,"permalink":"/6-key-value-storage/","noteIcon":""}
---

# Tags
- [[03 - Tags/가상 면접 사례로 배우는 대규모 시스템 설계 기초 1권\|가상 면접 사례로 배우는 대규모 시스템 설계 기초 1권]]
---
# 단서 질문

---
# 핵심 요약

---
# 핵심 필기
## 키값 저장소란?
데이터를 key,value 형태로 저장하는 시스템이다. Redis나 AWS의 DynamoDB[^1] 등이 있다.
## 요구 사항
- key와 value 데이터의 총합은 10KB
- 큰 데이터 저장 가능
- 높은 가용성을 제공. 시스템에 장애가 발생해도 빨리 응답해야 한다.
- 높은 규모 확장성을 제공해야 한다. 트래픽 양에 따라 서버 증설/삭제가 가능
- 데이터 일관성 수준을 조정할 수 있다.
- 응답 지연 시간이 짧아야 한다.
## 해결 방법
### 1. 단일 서버
당연하게도 가장 간단한 방법이다. 단일 서버에 메모리에 해시테이블로 모든 데이터를 저장한다.
만약, 메모리가 부족하다면 데이터를 압축하거나 접근 빈도가 낮은 데이터들을 디스크에 저장한다.
간단한 방법이지만 서버 한 대가 죽으면 모든 서비스가 다운되므로 가용성이 낮으며, 이후 트래픽이 증가함에 따라서 확장성이 커지기 힘들다. 모두 단일 서버에 의존하기 때문이다.
### 분산 키-값 저장소
분산 키-값 저장소는 분산 해시 테이블이라고 불린다. 여러 키-값을 서로 다른 서버에 분산 시키는 방법이다. 분산 시스템을 설계하기 위해선 CAP 정리를 이해할 필요가 있다.
#### CAP 정리
일관성(consistency), 가용성(availability), 파티션 감내(Partition Tolerance)를 의미한다.
일관성: 분산 시스템에 접속하여도 동일한 데이터를 보장한다.
가용성: 일부 노드에 장애가 발생하여도 서비스가 이용 가능하다.
파티션 감내: 분산 시스템의 노드 간에 통신이 불가능한 상태가 발생하여도 시스템은 계속 동작한다.[^2]

CAP 정리는 여기서 어떤 두 가지를 충족하려면 한 가지 희생이 필요하다는 것을 의미한다.[^3]

### 시스템 컴포넌트
키-값 저장소 구현에 사용될 핵심 컴포넌트와 기술들
- 데이터 파티션
- 데이터 다중화(replication)
- 일관성(consistency)
- 일관성 불일치 해소(inconsistency resolution)
- 장애 처리
- 시스템 아키텍처 다이어그램
- 쓰기 경로(write path)
- 읽기 경로(read path)
이번 절에서 구현하는 내용은 다이나모, 카산드라, 빅테이블의 사례를 참고한 것
#### 데이터 파티션
대규모 어플레킹션에서 전체 데이터를 한 대 서버에 욱여넣긴 사실상 불가능하다.
따라서, 데이터를 파티션을 통해 분할할 필요가 있다.
**데이터 파티션 시에 고려 사항**은 두 가지가 있다. 
첫 번째로 데이터를 고르게 분할할 수 있는가? 
두 번째로 노드가 추가되거나 삭제됐을 때, 데이터가 최소한으로 이동해야 한다.
이전에 배운 안정 해시 알고리즘이 해당 조건을 만족하는데 아주 적합한 방법이다.

데이터 파티션의 이점은 다음과 같다.
- 노드의 추가 및 삭제가 가능하다.
- 노드가 다양한 스펙을 가질 수 있다. 더 높은 사양을 가진 노드엔 가상 노드의 개수를 늘려서 더 많은 key를 저장하도록 만들 수 있다.
#### 데이터 다중화
높은 가용성과 안정성을 보장하기 위해서 데이터를 N개 서버에 비동기적으로 다중화한다. N개 서버를 선택하는 방법은 안정해시 알고리즘의 링을 사용한다.
![Pasted image 20250305233947.png](/img/user/Pasted%20image%2020250305233947.png)
기존엔 James가 db1에 저장되었다. 데이터 다중화를 위해 2개의 DB에 저장할 땐, James가 db1가 db2에 저장된다.
위 그림을 보면 알겠지만 N이 전체 물리 서버의 개수보다 커지면 안된다. 그렇게 되면 동일한 서버의 동일한 데이터가 중복되어 저장될 수 있다.
#### 데이터 일관성
데이터를 다중화하여 안정성을 추구하는 것은 옳다. 그러나, 비동기 데이터 복제로 인한 데이터의 일관성은 어떻게 보장할까? 일관성을 보장하기 위해서 다중화된 데이터는 적절하게 동기화가 되어야 한다.
정족수 합의(Quorum Consensus) 프로토콜을 사용하면 읽기/쓰기 연산 모두에 일관성을 보장할 수 있다.

---
# 참고 자료
 - http://eincs.com/2013/07/misleading-and-truth-of-cap-theorem/
# 주석

[^1]: Serverless 문서형 DB다. DocumentDB와는 달리 서버가 존재하지 않는다.

[^2]: 이걸 왜 Partition이라고 명칭할까? 내 생각엔 네트워크가 분리되어 통신이 불가능한 것을 파티션되었다고 생각하여 지은 명칭 같다. 서로 통신이 가능한 네트워크에서 통신이 불가능한 서로 다른 네트워크로 분리된 느낌이니까 파티션이라고 표현하는 듯하다.

[^3]: 단, CAP 정리는 실제 설계와 괴리감이 있다는 얘기가 많다. 따라서, PACELC가 더 부합하다고 본다.[[분산 시스템과 설계 원칙(CAP, PACELC)\|분산 시스템과 설계 원칙(CAP, PACELC)]]
